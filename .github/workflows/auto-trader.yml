name: Auto Trading Cron

on:
  schedule:
    # Runs every 5 minutes
    - cron: '*/5 * * * *'
  workflow_dispatch: # Allow manual trigger

env:
  RENDER_URL: https://cointracker-or1f.onrender.com
  SUPABASE_URL: https://iyenuoujyruaotydjjqg.supabase.co

jobs:
  analyze-market:
    runs-on: ubuntu-latest
    steps:
      - name: Run ML Analysis (100 Coins)
        id: analysis
        run: |
          echo "üîç Starting ML analysis of 100 coins..."

          response=$(curl -s -w "\n%{http_code}" -X GET \
            "${{ env.RENDER_URL }}/api/v3/analysis/run?coins=100&log_to_db=true" \
            -H "Content-Type: application/json" \
            --max-time 120)

          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | sed '$d')

          echo "HTTP Code: $http_code"

          if [ "$http_code" -ge 400 ]; then
            echo "‚ö†Ô∏è ML Backend returned error, falling back to Edge Function"
            echo "fallback=true" >> $GITHUB_OUTPUT
          else
            echo "‚úÖ ML Analysis complete"
            echo "$body" | jq -r '.summary' 2>/dev/null || echo "$body"
            echo "fallback=false" >> $GITHUB_OUTPUT

            # Extract strong signals for trading
            strong_buys=$(echo "$body" | jq -r '.strong_buys | length' 2>/dev/null || echo "0")
            strong_sells=$(echo "$body" | jq -r '.strong_sells | length' 2>/dev/null || echo "0")
            echo "üìà Strong Buys: $strong_buys"
            echo "üìâ Strong Sells: $strong_sells"
          fi

      - name: Execute Trades (Edge Function)
        if: steps.analysis.outputs.fallback == 'false'
        run: |
          echo "üí∞ Executing trades via Edge Function..."

          response=$(curl -s -w "\n%{http_code}" -X POST \
            "${{ env.SUPABASE_URL }}/functions/v1/auto-trader" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_ANON_KEY }}" \
            -H "Content-Type: application/json")

          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | sed '$d')

          echo "HTTP Code: $http_code"

          if [ "$http_code" -lt 400 ]; then
            echo "‚úÖ Trades executed"
            echo "$body" | jq '.' 2>/dev/null || echo "$body"
          else
            echo "‚ö†Ô∏è Trade execution failed: $body"
          fi

      - name: Fallback - Edge Function Only
        if: steps.analysis.outputs.fallback == 'true'
        env:
          SUPA_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
        run: |
          echo "üîÑ Running Edge Function fallback..."
          echo "Key length: ${#SUPA_KEY}"
          echo "Key starts with: ${SUPA_KEY:0:20}..."

          response=$(curl -s -w "\n%{http_code}" -X POST \
            "${{ env.SUPABASE_URL }}/functions/v1/auto-trader" \
            -H "Authorization: Bearer ${SUPA_KEY}" \
            -H "Content-Type: application/json")

          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | sed '$d')

          echo "Response: $body"
          echo "HTTP Code: $http_code"

          if [ "$http_code" -ge 400 ]; then
            echo "‚ùå Fallback also failed"
            exit 1
          fi
