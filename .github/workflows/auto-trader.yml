name: Auto Trading Cron

on:
  schedule:
    # Runs every 5 minutes for trading + stop-loss monitoring
    - cron: '*/5 * * * *'
    # Hourly learning update (track post-exit prices)
    - cron: '0 * * * *'
    # Daily auto-tune at 3 AM UTC
    - cron: '0 3 * * *'
    # Weekly optimization on Sundays at midnight UTC
    - cron: '0 0 * * 0'
  workflow_dispatch: # Allow manual trigger

env:
  RENDER_URL: https://cointracker-or1f.onrender.com
  SUPABASE_URL: https://iyenuoujyruaotydjjqg.supabase.co

jobs:
  # Quick stop-loss check - runs first for immediate protection
  check-stop-losses:
    runs-on: ubuntu-latest
    if: github.event.schedule != '0 0 * * 0'
    steps:
      - name: Check Stop-Losses (1st check)
        run: |
          echo "ðŸ›‘ Checking stop-losses..."
          response=$(curl -s -X POST "${{ env.RENDER_URL }}/api/v3/analysis/bot/check-stops" --max-time 30)
          echo "$response" | jq '.' 2>/dev/null || echo "$response"

      - name: Wait 1 minute
        run: sleep 60

      - name: Check Stop-Losses (2nd check)
        run: |
          echo "ðŸ›‘ Checking stop-losses (2nd)..."
          response=$(curl -s -X POST "${{ env.RENDER_URL }}/api/v3/analysis/bot/check-stops" --max-time 30)
          echo "$response" | jq '.' 2>/dev/null || echo "$response"

      - name: Wait 1 minute
        run: sleep 60

      - name: Check Stop-Losses (3rd check)
        run: |
          echo "ðŸ›‘ Checking stop-losses (3rd)..."
          response=$(curl -s -X POST "${{ env.RENDER_URL }}/api/v3/analysis/bot/check-stops" --max-time 30)
          echo "$response" | jq '.' 2>/dev/null || echo "$response"

      - name: Wait 1 minute
        run: sleep 60

      - name: Check Stop-Losses (4th check)
        run: |
          echo "ðŸ›‘ Checking stop-losses (4th)..."
          response=$(curl -s -X POST "${{ env.RENDER_URL }}/api/v3/analysis/bot/check-stops" --max-time 30)
          echo "$response" | jq '.' 2>/dev/null || echo "$response"

  analyze-and-trade:
    runs-on: ubuntu-latest
    steps:
      - name: Run ML Analysis + Bot Trading
        id: trading
        run: |
          echo "ðŸ¤– Starting ML analysis and autonomous trading..."
          echo "ðŸ“Š Analyzing 100 coins and executing trades..."

          response=$(curl -s -w "\n%{http_code}" -X POST \
            "${{ env.RENDER_URL }}/api/v3/analysis/run-and-trade?coins=100" \
            -H "Content-Type: application/json" \
            --max-time 180)

          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | sed '$d')

          echo "HTTP Code: $http_code"

          if [ "$http_code" -ge 400 ]; then
            echo "âš ï¸ Combined analysis/trade failed, trying analysis only..."
            echo "combined_failed=true" >> $GITHUB_OUTPUT
          else
            echo "âœ… Analysis and Trading complete"

            # Analysis summary
            echo "ðŸ“ˆ Analysis Summary:"
            echo "$body" | jq -r '.analysis.summary' 2>/dev/null || echo "N/A"

            # Bot trading results
            echo ""
            echo "ðŸ’° Bot Trading Results:"
            trades=$(echo "$body" | jq -r '.bot.trades_executed' 2>/dev/null || echo "0")
            buys=$(echo "$body" | jq -r '.bot.buys' 2>/dev/null || echo "0")
            sells=$(echo "$body" | jq -r '.bot.sells' 2>/dev/null || echo "0")
            balance=$(echo "$body" | jq -r '.bot.balance' 2>/dev/null || echo "N/A")
            pnl=$(echo "$body" | jq -r '.bot.total_pnl' 2>/dev/null || echo "N/A")

            echo "  Trades Executed: $trades"
            echo "  Buys: $buys"
            echo "  Sells: $sells"
            echo "  Balance: \$${balance}"
            echo "  Total PnL: \$${pnl}"

            # Show individual trade actions
            echo ""
            echo "ðŸ“‹ Trade Actions:"
            echo "$body" | jq -r '.bot.actions[]? | "  - \(.action) \(.coin): \(.reason // .signal) @ $\(.price // "N/A")"' 2>/dev/null || echo "  No trades executed"

            echo "combined_failed=false" >> $GITHUB_OUTPUT
          fi

      - name: Fallback - Analysis Only
        if: steps.trading.outputs.combined_failed == 'true'
        run: |
          echo "ðŸ”„ Running analysis-only fallback..."

          response=$(curl -s -w "\n%{http_code}" -X GET \
            "${{ env.RENDER_URL }}/api/v3/analysis/run?coins=100&log_to_db=true" \
            -H "Content-Type: application/json" \
            --max-time 120)

          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | sed '$d')

          echo "HTTP Code: $http_code"

          if [ "$http_code" -ge 400 ]; then
            echo "âŒ Analysis also failed"
            echo "$body"
            exit 1
          else
            echo "âœ… Analysis complete (trading skipped)"
            echo "$body" | jq -r '.summary' 2>/dev/null || echo "$body"
          fi

      - name: Get Bot Status
        if: always()
        run: |
          echo ""
          echo "ðŸ“Š Current Bot Status:"

          status=$(curl -s "${{ env.RENDER_URL }}/api/v3/analysis/bot/status" 2>/dev/null)

          if [ $? -eq 0 ]; then
            echo "$status" | jq '.' 2>/dev/null || echo "$status"
          else
            echo "Could not fetch bot status"
          fi

      - name: Check Learning Insights
        if: always()
        run: |
          echo ""
          echo "ðŸ§  Bot Learning Insights:"

          insights=$(curl -s "${{ env.RENDER_URL }}/api/v3/analysis/bot/learning" 2>/dev/null)

          if [ $? -eq 0 ]; then
            echo "Best performing signal: $(echo "$insights" | jq -r '.best_performing_signal // "N/A"')"
            echo "Worst performing signal: $(echo "$insights" | jq -r '.worst_performing_signal // "N/A"')"
            echo "Best coin: $(echo "$insights" | jq -r '.best_coin // "N/A"')"
            echo "Worst coin: $(echo "$insights" | jq -r '.worst_coin // "N/A"')"
            echo "Optimal score threshold: $(echo "$insights" | jq -r '.optimal_score_threshold // "N/A"')"
            echo "Total trades analyzed: $(echo "$insights" | jq -r '.total_trades_analyzed // 0')"

            # Show recommendations if any
            recs=$(echo "$insights" | jq -r '.recommendations[]? // empty')
            if [ -n "$recs" ]; then
              echo ""
              echo "ðŸ“‹ Recommendations:"
              echo "$recs" | while read rec; do
                echo "  â€¢ $rec"
              done
            fi
          else
            echo "Could not fetch learning insights"
          fi

  # Weekly optimization + ML training job (runs on Sunday schedule)
  weekly-optimize:
    runs-on: ubuntu-latest
    if: github.event.schedule == '0 0 * * 0'
    steps:
      - name: Trigger ML Data Labeling
        run: |
          echo "ðŸ·ï¸ Triggering ML data labeling..."

          response=$(curl -s -w "\n%{http_code}" -X POST \
            "${{ env.RENDER_URL }}/api/v3/analysis/ml/label" \
            -H "Content-Type: application/json" \
            --max-time 120)

          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | sed '$d')

          echo "HTTP Code: $http_code"
          if [ "$http_code" -lt 400 ]; then
            labeled=$(echo "$body" | jq -r '.labeled // 0')
            skipped=$(echo "$body" | jq -r '.skipped // 0')
            echo "âœ… Labeled: $labeled, Skipped: $skipped"
          else
            echo "âš ï¸ Labeling failed: $body"
          fi

      - name: Check ML Training Stats
        id: ml_stats
        run: |
          echo "ðŸ“Š Checking ML training data..."

          response=$(curl -s "${{ env.RENDER_URL }}/api/v3/analysis/ml/stats" 2>/dev/null)

          labeled=$(echo "$response" | jq -r '.labeled_samples // 0')
          total=$(echo "$response" | jq -r '.total_samples // 0')
          days=$(echo "$response" | jq -r '.days_of_data // 0')

          echo "  Total samples: $total"
          echo "  Labeled samples: $labeled"
          echo "  Days of data: $days"

          if [ "$labeled" -ge 500 ]; then
            echo "ready_for_training=true" >> $GITHUB_OUTPUT
            echo "âœ… Enough data for ML training!"
          else
            echo "ready_for_training=false" >> $GITHUB_OUTPUT
            echo "â³ Need more data (have $labeled, need 500+)"
          fi

      - name: Train ML Models
        if: steps.ml_stats.outputs.ready_for_training == 'true'
        run: |
          echo "ðŸ§  Training ML models..."

          response=$(curl -s -w "\n%{http_code}" -X POST \
            "${{ env.RENDER_URL }}/api/v3/analysis/ml/train?min_samples=500" \
            -H "Content-Type: application/json" \
            --max-time 600)

          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | sed '$d')

          echo "HTTP Code: $http_code"

          if [ "$http_code" -lt 400 ]; then
            error=$(echo "$body" | jq -r '.error // empty')
            if [ -z "$error" ]; then
              echo "âœ… ML Training complete!"
              echo "  XGBoost: $(echo "$body" | jq -r '.xgboost.accuracy // "N/A"')% accuracy"
              echo "  LSTM: $(echo "$body" | jq -r '.lstm.accuracy // "N/A"')% accuracy"
            else
              echo "âš ï¸ Training skipped: $error"
            fi
          else
            echo "âŒ Training failed: $body"
          fi

      - name: Auto-Optimize Bot Settings
        run: |
          echo "ðŸ”§ Running weekly bot optimization..."

          response=$(curl -s -w "\n%{http_code}" -X POST \
            "${{ env.RENDER_URL }}/api/v3/analysis/bot/optimize" \
            -H "Content-Type: application/json" \
            --max-time 30)

          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | sed '$d')

          echo "HTTP Code: $http_code"

          if [ "$http_code" -lt 400 ]; then
            optimized=$(echo "$body" | jq -r '.optimized // false')
            if [ "$optimized" = "true" ]; then
              echo "âœ… Bot optimized successfully!"
              echo "  New min_signal_score: $(echo "$body" | jq -r '.new_min_signal_score // "unchanged"')"
              echo "  Removed coins: $(echo "$body" | jq -r '.removed_coins // "none"')"
              echo "  Trades analyzed: $(echo "$body" | jq -r '.trades_analyzed // 0')"
            else
              echo "â„¹ï¸ Optimization skipped: $(echo "$body" | jq -r '.reason // "unknown"')"
            fi
          else
            echo "âš ï¸ Optimization failed: $body"
          fi

  # Hourly learning update - track prices after exits
  hourly-learning-update:
    runs-on: ubuntu-latest
    if: github.event.schedule == '0 * * * *'
    steps:
      - name: Update Post-Exit Price Tracking
        run: |
          echo "ðŸ“ˆ Updating post-exit price tracking..."

          response=$(curl -s -w "\n%{http_code}" -X POST \
            "${{ env.RENDER_URL }}/api/v3/analysis/learning/update-exits" \
            -H "Content-Type: application/json" \
            --max-time 60)

          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | sed '$d')

          echo "HTTP Code: $http_code"

          if [ "$http_code" -lt 400 ]; then
            updated=$(echo "$body" | jq -r '.exits_updated // 0')
            completed=$(echo "$body" | jq -r '.analyses_completed // 0')
            echo "âœ… Updated: $updated exits, Completed: $completed analyses"
          else
            echo "âš ï¸ Update failed: $body"
          fi

  # Daily auto-tune - adjust trailing stop multipliers based on learning
  daily-auto-tune:
    runs-on: ubuntu-latest
    if: github.event.schedule == '0 3 * * *'
    steps:
      - name: Auto-Tune Trailing Stops
        run: |
          echo "ðŸŽ¯ Running daily auto-tune..."

          response=$(curl -s -w "\n%{http_code}" -X POST \
            "${{ env.RENDER_URL }}/api/v3/analysis/learning/auto-tune" \
            -H "Content-Type: application/json" \
            --max-time 60)

          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | sed '$d')

          echo "HTTP Code: $http_code"

          if [ "$http_code" -lt 400 ]; then
            echo "$body" | jq '.' 2>/dev/null || echo "$body"

            normal_mult=$(echo "$body" | jq -r '.current_multipliers.normal // "N/A"')
            bullrun_mult=$(echo "$body" | jq -r '.current_multipliers.bullrun // "N/A"')
            premature_rate=$(echo "$body" | jq -r '.premature_exit_rate // "N/A"')

            echo ""
            echo "ðŸ“Š Current Status:"
            echo "  Normal Trail Multiplier: ${normal_mult}x"
            echo "  Bullrun Trail Multiplier: ${bullrun_mult}x"
            echo "  Premature Exit Rate: ${premature_rate}%"
          else
            echo "âš ï¸ Auto-tune failed: $body"
          fi

      - name: Show Learning Stats
        run: |
          echo ""
          echo "ðŸ§  Learning Statistics:"

          response=$(curl -s "${{ env.RENDER_URL }}/api/v3/analysis/learning/stats" 2>/dev/null)

          if [ $? -eq 0 ]; then
            echo "$response" | jq '.' 2>/dev/null || echo "$response"
          else
            echo "Could not fetch learning stats"
          fi
