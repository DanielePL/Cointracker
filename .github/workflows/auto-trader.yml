name: Auto Trading Cron

on:
  schedule:
    # Runs every 5 minutes for trading
    - cron: '*/5 * * * *'
    # Weekly optimization on Sundays at midnight UTC
    - cron: '0 0 * * 0'
  workflow_dispatch: # Allow manual trigger

env:
  RENDER_URL: https://cointracker-or1f.onrender.com
  SUPABASE_URL: https://iyenuoujyruaotydjjqg.supabase.co

jobs:
  analyze-and-trade:
    runs-on: ubuntu-latest
    steps:
      - name: Run ML Analysis + Bot Trading
        id: trading
        run: |
          echo "ü§ñ Starting ML analysis and autonomous trading..."
          echo "üìä Analyzing 50 coins and executing trades..."

          response=$(curl -s -w "\n%{http_code}" -X POST \
            "${{ env.RENDER_URL }}/api/v3/analysis/run-and-trade?coins=50" \
            -H "Content-Type: application/json" \
            --max-time 180)

          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | sed '$d')

          echo "HTTP Code: $http_code"

          if [ "$http_code" -ge 400 ]; then
            echo "‚ö†Ô∏è Combined analysis/trade failed, trying analysis only..."
            echo "combined_failed=true" >> $GITHUB_OUTPUT
          else
            echo "‚úÖ Analysis and Trading complete"

            # Analysis summary
            echo "üìà Analysis Summary:"
            echo "$body" | jq -r '.analysis.summary' 2>/dev/null || echo "N/A"

            # Bot trading results
            echo ""
            echo "üí∞ Bot Trading Results:"
            trades=$(echo "$body" | jq -r '.bot.trades_executed' 2>/dev/null || echo "0")
            buys=$(echo "$body" | jq -r '.bot.buys' 2>/dev/null || echo "0")
            sells=$(echo "$body" | jq -r '.bot.sells' 2>/dev/null || echo "0")
            balance=$(echo "$body" | jq -r '.bot.balance' 2>/dev/null || echo "N/A")
            pnl=$(echo "$body" | jq -r '.bot.total_pnl' 2>/dev/null || echo "N/A")

            echo "  Trades Executed: $trades"
            echo "  Buys: $buys"
            echo "  Sells: $sells"
            echo "  Balance: \$${balance}"
            echo "  Total PnL: \$${pnl}"

            # Show individual trade actions
            echo ""
            echo "üìã Trade Actions:"
            echo "$body" | jq -r '.bot.actions[]? | "  - \(.action) \(.coin): \(.reason // .signal) @ $\(.price // "N/A")"' 2>/dev/null || echo "  No trades executed"

            echo "combined_failed=false" >> $GITHUB_OUTPUT
          fi

      - name: Fallback - Analysis Only
        if: steps.trading.outputs.combined_failed == 'true'
        run: |
          echo "üîÑ Running analysis-only fallback..."

          response=$(curl -s -w "\n%{http_code}" -X GET \
            "${{ env.RENDER_URL }}/api/v3/analysis/run?coins=100&log_to_db=true" \
            -H "Content-Type: application/json" \
            --max-time 120)

          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | sed '$d')

          echo "HTTP Code: $http_code"

          if [ "$http_code" -ge 400 ]; then
            echo "‚ùå Analysis also failed"
            echo "$body"
            exit 1
          else
            echo "‚úÖ Analysis complete (trading skipped)"
            echo "$body" | jq -r '.summary' 2>/dev/null || echo "$body"
          fi

      - name: Get Bot Status
        if: always()
        run: |
          echo ""
          echo "üìä Current Bot Status:"

          status=$(curl -s "${{ env.RENDER_URL }}/api/v3/analysis/bot/status" 2>/dev/null)

          if [ $? -eq 0 ]; then
            echo "$status" | jq '.' 2>/dev/null || echo "$status"
          else
            echo "Could not fetch bot status"
          fi

      - name: Check Learning Insights
        if: always()
        run: |
          echo ""
          echo "üß† Bot Learning Insights:"

          insights=$(curl -s "${{ env.RENDER_URL }}/api/v3/analysis/bot/learning" 2>/dev/null)

          if [ $? -eq 0 ]; then
            echo "Best performing signal: $(echo "$insights" | jq -r '.best_performing_signal // "N/A"')"
            echo "Worst performing signal: $(echo "$insights" | jq -r '.worst_performing_signal // "N/A"')"
            echo "Best coin: $(echo "$insights" | jq -r '.best_coin // "N/A"')"
            echo "Worst coin: $(echo "$insights" | jq -r '.worst_coin // "N/A"')"
            echo "Optimal score threshold: $(echo "$insights" | jq -r '.optimal_score_threshold // "N/A"')"
            echo "Total trades analyzed: $(echo "$insights" | jq -r '.total_trades_analyzed // 0')"

            # Show recommendations if any
            recs=$(echo "$insights" | jq -r '.recommendations[]? // empty')
            if [ -n "$recs" ]; then
              echo ""
              echo "üìã Recommendations:"
              echo "$recs" | while read rec; do
                echo "  ‚Ä¢ $rec"
              done
            fi
          else
            echo "Could not fetch learning insights"
          fi

  # Weekly optimization job (runs on Sunday schedule or manual trigger)
  weekly-optimize:
    runs-on: ubuntu-latest
    if: github.event.schedule == '0 0 * * 0'
    steps:
      - name: Auto-Optimize Bot Settings
        run: |
          echo "üîß Running weekly bot optimization..."

          response=$(curl -s -w "\n%{http_code}" -X POST \
            "${{ env.RENDER_URL }}/api/v3/analysis/bot/optimize" \
            -H "Content-Type: application/json" \
            --max-time 30)

          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | sed '$d')

          echo "HTTP Code: $http_code"

          if [ "$http_code" -lt 400 ]; then
            optimized=$(echo "$body" | jq -r '.optimized // false')
            if [ "$optimized" = "true" ]; then
              echo "‚úÖ Bot optimized successfully!"
              echo "  New min_signal_score: $(echo "$body" | jq -r '.new_min_signal_score // "unchanged"')"
              echo "  Removed coins: $(echo "$body" | jq -r '.removed_coins // "none"')"
              echo "  Trades analyzed: $(echo "$body" | jq -r '.trades_analyzed // 0')"
            else
              echo "‚ÑπÔ∏è Optimization skipped: $(echo "$body" | jq -r '.reason // "unknown"')"
            fi
          else
            echo "‚ö†Ô∏è Optimization failed: $body"
          fi
